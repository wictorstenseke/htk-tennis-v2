rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is a superuser
    function isSuperUser() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && 'role' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser';
    }

    // Helper function to check if the requesting user is admin or superuser
    function isAdminOrSuperUser() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && 'role' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superuser'];
    }

    // Helper function to check if only ladder stats are being updated
    function onlyUpdatingLadderStats() {
      return request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasOnly(['ladderWins', 'ladderLosses']);
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();

      // Allow users to create their own document with role "user", but not "admin" or "superuser"
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && (!('role' in request.resource.data) || request.resource.data.role == 'user');

      allow update: if isAuthenticated() && (
        // User is updating their own data without changing role to admin/superuser
        (request.auth.uid == userId && (
          (!('role' in request.resource.data) && !('role' in resource.data))
          || ('role' in request.resource.data && 'role' in resource.data && request.resource.data.role == resource.data.role)
          || ('role' in request.resource.data && request.resource.data.role == 'user')
        ))
        // OR any authenticated user can update ladder stats
        || onlyUpdatingLadderStats()
        // OR superuser can update anything
        || isSuperUser()
      );
    }

    // Bookings collection - authenticated users can manage bookings
    match /bookings/{bookingId} {
      // Allow authenticated users to read all bookings (needed for calendar view)
      allow read: if isAuthenticated();

      // Allow authenticated users to create bookings with required fields
      allow create: if isAuthenticated()
        && request.resource.data.userId is string
        && request.resource.data.startDate is timestamp
        && request.resource.data.endDate is timestamp
        && request.resource.data.createdAt is timestamp
        // Ladder match fields are optional
        && (!('playerAId' in request.resource.data) || request.resource.data.playerAId is string)
        && (!('playerBId' in request.resource.data) || request.resource.data.playerBId is string)
        && (!('ladderStatus' in request.resource.data) || request.resource.data.ladderStatus in ['planned', 'completed'])
        && (!('winnerId' in request.resource.data) || request.resource.data.winnerId is string)
        && (!('comment' in request.resource.data) || request.resource.data.comment is string)
        && (!('ladderId' in request.resource.data) || request.resource.data.ladderId is string);

      // Allow users to update their own bookings
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Allow users to delete their own bookings
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // App Settings collection - controls global app behavior
    match /appSettings/{settingId} {
      // All authenticated users can read settings (e.g., to check if bookings are enabled)
      allow read: if isAuthenticated();

      // Only admins and superusers can modify app settings
      allow write: if isAdminOrSuperUser();
    }

    // Announcements collection - displays messages to users
    match /announcements/{announcementId} {
      // All authenticated users can read announcements
      allow read: if isAuthenticated();

      // Only admins and superusers can create/update announcements
      allow write: if isAdminOrSuperUser();
    }

    // Ladders collection - manages ladder seasons and participants
    match /ladders/{ladderId} {
      // All authenticated users can read ladders
      allow read: if isAuthenticated();

      // Only admins and superusers can create or delete ladders
      allow create, delete: if isAdminOrSuperUser();

      // Users can update participants if they are adding themselves
      // (existing participants are preserved and only the authenticated user is added)
      allow update: if isAuthenticated() && (
        // Check that all existing participants are still present
        request.resource.data.participants.hasAll(resource.data.participants)
        // And only the authenticated user was added
        && request.resource.data.participants.removeAll(resource.data.participants).hasOnly([request.auth.uid])
      );

      // Admins can update anything
      allow update: if isAdminOrSuperUser();
    }
  }
}
